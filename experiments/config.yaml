# General parameters
# Path to dataset
EXPERT_DATA:    /mnt/sdc1/frosa/multitask_dataset/mosaic_multitask_dataset
save_path:      /user/frosa/robotic/multitask_lfd/training_log
save_freq:      1000
log_freq:       1000
val_freq:       1000 
print_freq:     1000
save_optim:     False
resume:         False
resume_path:    None
device:         3
exp_name:       -1
epochs:         10
bsize:          30
vsize:          ${bsize} # optionally, set to a different batchsize for validation loader

# imitation loss multipliers
inv_mul:        1
bc_mul:         1
pnt_mul:        0
rep_muls:
  img_byol:           ${byol.mul_pre}
  attn_byol:          ${byol.mul_pos}
  demo_byol:          ${byol.mul_demo}
  intm_byol:          ${byol.mul_intm}
  simclr_pre:         ${simclr.mul_pre}
  simclr_post:        ${simclr.mul_pos}
  simclr_intm:        ${simclr.mul_intm}

wandb_log: False 
# training configurations
train_cfg:
  batch_size:           ${bsize}
  val_size:             ${vsize}
  lr:                   5e-4
  epochs:               ${epochs}
  log_freq:             ${log_freq}
  val_freq:             ${val_freq}
  save_freq:            ${save_freq}
  print_freq:           ${print_freq}
  inv_loss_mult:        ${inv_mul}
  bc_loss_mult:         ${bc_mul}
  pnt_loss_mult:        ${pnt_mul}
  rep_loss_muls:        ${rep_muls}
  dataset:              ${dataset_cfg}
  sampler:              ${samplers}
  target_update_freq:   5  # used for soft parameter update

# tasks related
tasks:       ???
single_task: False 
exclude_task: False 
use_all_tasks: False 
# number of trajectory of the same task 
set_same_n:   -1 
# number of trajectory for sub-task
limit_num_traj: -1
limit_num_demo: -1
defaults:
  - tasks_cfgs:  7_tasks

# dataset/loader/samplers
loader_workers:     10 
samplers:        
  batch_size:         ${bsize}
  drop_last:          False
  shuffle:            True 
val_skip:             False # whether to let the samplers skip some **sub**tasks
train_skip:           True

dataset_cfg:
  _target_:         'mosaic.datasets.multi_task_datasets.MultiTaskPairedDataset'
  root_dir:         ${EXPERT_DATA}/
  mode:             ???
  tasks_spec:       ${tasks}
  aux_pose:         True # only required for DAML baseline 
  height:           100
  width:            180
  split:            [0.9, 0.1]
  demo_T:           4 # number of timestamps for demonstrator
  obs_T:            7 # number of timestamps for learner
  data_augs:        ${augs}
  non_sequential:   False
  crop_twice:       True
  state_spec:       [ee_aa, gripper_qpos]
  allow_val_skip:   ${val_skip}
  allow_train_skip: ${train_skip}
  use_strong_augs:  True 
  # name of the agent (learner)
  agent_name: ur5e
  # name of the demonstrator (teacher)
  demo_name: ur5e
  
augs:
  strong_jitter:     0.01    
  weak_jitter:       0.01
  grayscale:         0.01   
  blur:              [0.1, 2.0] 
  flip:              0.05   # only flip for the strong augs
  weak_crop_scale:   [0.7, 1.0] 
  strong_crop_scale: [0.6, 1.0] 
  weak_crop_ratio:   [1.8, 1.8]
  strong_crop_ratio: [1.8, 1.8]
  use_affine:        False  
  rand_trans:        0.1


simclr:
  demo_T:           ${train_cfg.dataset.demo_T}
  obs_T:            ${train_cfg.dataset.obs_T} 
  mul_pre:          1
  mul_pos:          1
  mul_intm:         0
  tau:              0.005      
  compressor_dim:   128
  temporal:         True
  hidden_dim:       256
  fix_step:         -1 
byol: 
  p:                2
  project_dim:      128
  hidden_dim:       256
  demo_T:           ${train_cfg.dataset.demo_T}
  obs_T:            ${train_cfg.dataset.obs_T}   
  demo_proj:        True
  share_mlp:        True 
  no_hidden:        False
  draw_apart:       False
  mul_pre:          0
  mul_pos:          0
  mul_intm:         0 
  mul_demo:         0

# model related
policy: ???  # set to any set of configs via command line, e.g. policy='${tosil}'

mosaic:
  # name of the module to use
  _target_:           mosaic.models.mt_rep.VideoImitation 
  latent_dim:         40
  sdim:               9
  concat_state:       False
  height:             ${train_cfg.dataset.height}
  width:              ${train_cfg.dataset.width} 
  demo_T:             ${train_cfg.dataset.demo_T}
  obs_T:              ${train_cfg.dataset.obs_T}   
  dim_H:              7
  dim_W:              12  
  demo_mean:          True 
  action_cfg:         ${actions}
  concat_demo_head:   True
  concat_demo_act:    False 
  attn_cfg:           ${attn}
  byol_config:        ${byol}
  simclr_config:      ${simclr}

actions:
  n_layers:         2    
  out_dim:          64
  hidden_dim:       128
  adim:             8
  n_mixtures:       4   
  const_var:        False
  sep_var:          True 
  concat_demo_head: True
  concat_demo_act:  False
  demo_mean:        ${policy.demo_mean}

attn:
  embed_hidden:     256
  dropout:          0.2
  n_attn_layers:    2
  attn_heads:       4
  attn_ff:          128
  pos_enc:          True 
  fuse_starts:      0   # default 0 so attend everywhere
  causal:           True
  attend_demo:      True
  demo_out:         True     
  img_cfg:           
    network_flag:   0 # e.g Res18  
    out_feature:    256
    drop_dim:       3 
    pretrained:     False 

tosil:
  _target_:         mosaic.models.baselines.InverseImitation 
  latent_dim:       40
  lstm_config:
    out_dim:        32
    n_layers:       1
    is_rnn:         False
  vis:
    conv_drop_dim:  3 
    st_goal_attn:   True
    n_st_attn:      2
    use_pe:         True
    attn_heads:     4
  n_mixtures:       2
  const_var:        True
  concat_state:     False
  pred_point:       True

lstm:
  _target_:         mosaic.models.baselines.InverseImitation 
  latent_dim:       40
  lstm_config:
    out_dim:        32
    n_layers:       1
    is_rnn:         False
  vis:
    temp_convs:     False
    lstm:           True
    out_feature:    256
    context_T:      4
  n_mixtures:       2
  const_var:        True
  concat_state:     False
  pred_point:       True
  transformer_feat: False

use_daml: False
daml:
  _target_: mosaic.models.baselines.DAMLNetwork
  n_final_convs: 'resnet'
  T_context: 4
  maml_lr: 0.1
  first_order: False
  n_mix: 2
  const_var: True
  inner_iters: 1
